---
import Layout from '../layouts/Layout.astro';
import OSDemo from '../components/OSDemo.tsx';
---

<Layout title="OS Demo">
	<noscript>
		This demo requires JavaScript.
	</noscript>
	<div id="demo-container" class="prose">
		<div class="flex flex-col gap-y-6 mb-6">
			<h1 class="text-2xl font-bold">Otium OS Demo</h1>
			<p>
				This demo runs the Otium operating system compiled to WebAssembly.
			</p>

			<p>
				The OS is written in Zig and runs in your browser. Click "Run" to start the kernel.
			</p>

			<p>
				For more information, check out the source code on <a href="https://github.com/upvalue/otium" target="_blank" rel="noopener noreferrer">GitHub</a>.
			</p>
		</div>
		<OSDemo client:only="react" />
	</div>
	<div id="error-fallback" style="display: none;" class="mx-auto text-red-400 bg-red-900/20 border border-red-500 rounded-lg p-4">
		<h2 class="text-xl font-bold mb-2">Demo Component Failed to Load</h2>
		<p class="mb-2">There was an error loading the OS demo component. Check the browser console for details.</p>
		<details class="mt-4">
			<summary class="cursor-pointer font-medium">Error Details</summary>
			<pre id="error-details" class="mt-2 p-3 bg-gray-800 rounded text-sm overflow-auto"></pre>
		</details>
	</div>
</Layout>

<script>
	// Listen for component errors and show fallback
	window.addEventListener('error', (e) => {
		if (e.filename?.includes('OSDemo') || e.message?.includes('astro-island')) {
			const container = document.getElementById('demo-container');
			const fallback = document.getElementById('error-fallback');
			const details = document.getElementById('error-details');

			if (container && fallback && details) {
				container.style.display = 'none';
				fallback.style.display = 'block';
				details.textContent = `${e.message}\nFile: ${e.filename}\nLine: ${e.lineno}:${e.colno}`;
			}
		}
	});

	// Also listen for unhandled promise rejections
	window.addEventListener('unhandledrejection', (e) => {
		if (e.reason?.message?.includes('wasm') || e.reason?.message?.includes('WebAssembly')) {
			const container = document.getElementById('demo-container');
			const fallback = document.getElementById('error-fallback');
			const details = document.getElementById('error-details');

			if (container && fallback && details) {
				container.style.display = 'none';
				fallback.style.display = 'block';
				details.textContent = `Promise Rejection: ${e.reason?.message || e.reason}`;
			}
		}
	});
</script>
